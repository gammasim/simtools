# syntax=docker/dockerfile:1.4
# Dockerfile for sim_telarray
#

# Shared build arguments
ARG EXTRA_DEFINES="-DMAXIMUM_TELESCOPES=99 -DCTA_PROD6"
ARG SIMTEL_VERSION="master"
ARG HESSIO_VERSION="master"
ARG STDTOOLS_VERSION="master"

# hadolint global ignore=DL3013,DL3033,DL3041,SC1091
# - DL3013, DL3033: ignore warnings about installing non-specific versions with microdnf or yum)
# - SC1091: ignore warning about not being able to source the bashrc

# -----------------------------------------------------------------------------
# STAGE 1: source code preparation
# -----------------------------------------------------------------------------
FROM almalinux:9.5-minimal AS source_preparation
ARG SIMTEL_REPO="gitlab.cta-observatory.org/cta-computing/dpps/simpipe/simulation_software/sim_telarray.git"
ARG SIMTEL_VERSION
ARG HESSIO_REPO="gitlab.cta-observatory.org/cta-computing/dpps/simpipe/simulation_software/hessio.git"
ARG HESSIO_VERSION
ARG STDTOOLS_REPO="gitlab.cta-observatory.org/cta-computing/dpps/simpipe/simulation_software/stdtools.git"
ARG STDTOOLS_VERSION

RUN microdnf update -y && microdnf install -y git && \
    microdnf clean all

WORKDIR /src

# Clone sim_telarray from CTAO gitlab
RUN --mount=type=secret,id=sim_telarray_token \
    git config --global advice.detachedHead false && \
    git clone --depth 1 --branch "${SIMTEL_VERSION}" "https://oauth2:$(cat /run/secrets/sim_telarray_token)@${SIMTEL_REPO}" && \
    cd sim_telarray && rm -rf .git

# Clone hessio from CTAO gitlab
#RUN --mount=type=secret,id=hessio_token \
#    git config --global advice.detachedHead false && \
#    git clone --depth 1 --branch "${HESSIO_VERSION}" "https://oauth2:$(cat /run/secrets/hessio_token)@${HESSIO_REPO}" && \
#    cd hessio && rm -rf .git
# TODO temporarily uses tar package
ADD hessioxxx.tar.gz .

# Clone stdtools from CTAO gitlab
RUN --mount=type=secret,id=stdtools_token \
    git config --global advice.detachedHead false && \
    git clone --depth 1 --branch "${STDTOOLS_VERSION}" "https://oauth2:$(cat /run/secrets/stdtools_token)@${STDTOOLS_REPO}" && \
    cd stdtools && rm -rf .git

# -----------------------------------------------------------------------------
# STAGE 2: build_image
# -----------------------------------------------------------------------------
FROM almalinux:9.5 AS build_image
ARG EXTRA_DEFINES
ARG SIMTEL_VERSION="master"
ARG HESSIO_VERSION="master"
ARG STDTOOLS_VERSION="master"
ARG GSL_COMPILE="-DWITH_GSL -DWITH_GSL_RNG"

ENV GCC_PATH="/usr/bin/"

RUN yum update -y && yum install -y \
    gcc-fortran gsl-devel libgfortran \
    automake csh patch perl which bzip2 \
    wget make tar m4 && \
    yum clean all

WORKDIR /workdir
COPY --from=source_preparation /src .

WORKDIR /workdir/hessioxxx
RUN make clean && \
    make WITH_RPATH=1 DEFINES="${EXTRA_DEFINES} ${GSL_COMPILE}" && \
    rm -rf ./out ./doc ./root ./hessio_refman.pdf

WORKDIR /workdir/stdtools
RUN make WITH_RPATH=1 EXTRA_DEFINES="${EXTRA_DEFINES} ${GSL_COMPILE}" && \
    mv -v -f out/libstdtools.so ./lib && rm -rf out

WORKDIR /workdir/sim_telarray
# Create version.h file
RUN echo "#define VERSION \"$(date -u '+%Y.%j %H:%M:%S') UTC ($(whoami)@$(hostname))\"" > version.h && \
    echo '#define RELEASE "2025.246.0 from 2025-09-03"' >> version.h && \
    echo '#ifdef BASE_RELEASE' >> version.h && \
    echo '# undef BASE_RELEASE' >> version.h && \
    echo '#endif' >> version.h && \
    echo '#define BASE_RELEASE "2025.246.0 from 2025-09-03"' >> version.h

# build sim_telarray with debug trace
RUN make WITH_RPATH=1 EXTRA_DEFINES="${EXTRA_DEFINES} -DDEBUG_TRACE_99 ${GSL_COMPILE}" install && \
    mv -v ./bin/sim_telarray ./bin/sim_telarray_debug_trace

# build std sim_telarray
RUN make clean && \
    make WITH_RPATH=1 EXTRA_DEFINES="${EXTRA_DEFINES} ${GSL_COMPILE}" install && \
    rm -fr ./cfg/* ./corsika ./hegra ./hess ./doc_src ./doc ./LightEmission/out && \
    rm -vf LightEmission/LightSourcesPresentation.pdf && \
    find . -name "*.o" -exec rm -f {} \;

# Generate config.yml with build information
RUN echo "SIMTEL_VERSION: \"${SIMTEL_VERSION}\"" > config.yml && \
    echo "HESSIO_VERSION: \"${HESSIO_VERSION}\"" >> config.yml && \
    echo "STDTOOLS_VERSION: \"${STDTOOLS_VERSION}\"" >> config.yml && \
    echo "EXTRA_DEFINES: \"${EXTRA_DEFINES}\"" >> config.yml && \
    echo "BUILD_DATE: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> config.yml && \
    echo "COMPONENTS:" >> config.yml && \
    echo "  - NAME: \"hessioxxx\"" >> config.yml && \
    echo "    VERSION: \"${HESSIO_VERSION}\"" >> config.yml && \
    echo "    BUILD_FLAGS: \"DEFINES=${EXTRA_DEFINES} ${GSL_COMPILE}\"" >> config.yml && \
    echo "  - NAME: \"stdtools\"" >> config.yml && \
    echo "    VERSION: \"${STDTOOLS_VERSION}\"" >> config.yml && \
    echo "    BUILD_FLAGS: \"EXTRA_DEFINES=${EXTRA_DEFINES} ${GSL_COMPILE}\"" >> config.yml && \
    echo "  - NAME: \"sim_telarray\"" >> config.yml && \
    echo "    VERSION: \"${SIMTEL_VERSION}\"" >> config.yml && \
    echo "    BUILD_FLAGS: \"EXTRA_DEFINES=${EXTRA_DEFINES} ${GSL_COMPILE}\"" >> config.yml && \
    echo "    EXECUTABLES:" >> config.yml && \
    echo "      - \"sim_telarray\"" >> config.yml && \
    echo "  - NAME: \"sim_telarray_debug_trace\"" >> config.yml && \
    echo "    VERSION: \"${SIMTEL_VERSION}\"" >> config.yml && \
    echo "    BUILD_FLAGS: \"EXTRA_DEFINES=${EXTRA_DEFINES} ${GSL_COMPILE}\"" >> config.yml && \
    echo "    EXECUTABLES:" >> config.yml && \
    echo "      - \"sim_telarray_debug_trace\"" >> config.yml

# -----------------------------------------------------------------------------
# STAGE 3: Runtime Image
# -----------------------------------------------------------------------------
FROM almalinux:9.5-minimal
WORKDIR /workdir/simulation_software
COPY --from=build_image /workdir/hessioxxx /workdir/simulation_software/hessioxxx
COPY --from=build_image /workdir/stdtools /workdir/simulation_software/stdtools
COPY --from=build_image /workdir/sim_telarray /workdir/simulation_software/sim_telarray

RUN microdnf update -y && microdnf install -y \
    bc \
    zstd \
    gsl-devel \
    gcc-fortran \
    procps \
    findutils \
    gcc-c++ \
    libgfortran && \
    microdnf clean all && \

WORKDIR /workdir/simulation_software/corsika
