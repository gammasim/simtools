---
name: CI-integrationtests

on:
  workflow_dispatch:
    inputs:
      simulation_model_branch:
        description: 'Simulation model branch'
        required: false
        type: string
        default: 'main'

  workflow_call:
    inputs:
      container_image:
        description: 'Container image to use for tests'
        required: false
        type: string
        default: 'ghcr.io/gammasim/simtools-dev:latest'
      model_versions:
        description: 'Model versions to test'
        required: false
        type: string
        default: '["7.0.0","6.0.2","5.0.0","6.0.2,6.1.1"]'

  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - 'docs/**'
      - 'tests/unit_tests/**'

  schedule:
    - cron: "0 0 * * *"

  release:
    types: [published]

jobs:

  test_building:
    if: ${{ github.event_name != 'workflow_call' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash -leo pipefail {0}

    steps:
      - uses: actions/checkout@v6

      - name: Build package
        run: |
          python -m pip install --upgrade pip build
          python -m build

  integration_tests:
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.container_image || 'ghcr.io/gammasim/simtools-dev:latest' }}
      options: --user 0

    services:
      mongodb:
        image: mongo:latest
        env:
          MONGO_INITDB_ROOT_USERNAME: api
          MONGO_INITDB_ROOT_PASSWORD: password
        options: >-
          --health-cmd "mongosh --host localhost --port 27017 -u api -p password --authenticationDatabase admin --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      fail-fast: false
      matrix:
        model_version: ${{ fromJSON(inputs.model_versions || '["7.0.0","6.0.2","5.0.0","6.0.2,6.1.1"]') }}

    defaults:
      run:
        shell: bash -leo pipefail {0}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extend PATH (optional)
        run: |
          [ -n "$SIMTOOLS_SIMTEL_PATH" ] && echo "$SIMTOOLS_SIMTEL_PATH" >> "$GITHUB_PATH"

      - name: Create runtime environment (.env)
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_BRANCH: ${{ github.event.inputs.simulation_model_branch }}
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
          SECRET_DB_SERVER: ${{ secrets.DB_SERVER }}
          SECRET_DB_API_USER: ${{ secrets.DB_API_USER }}
          SECRET_DB_API_PW: ${{ secrets.DB_API_PW }}
          SECRET_DB_API_PORT: ${{ secrets.DB_API_PORT }}
        run: |
          set -a
          source .env_template
          set +a

          DB_SERVER=mongodb
          DB_API_USER=api
          DB_API_PW=password
          DB_API_PORT=27017

          if [ "$EVENT_NAME" = "schedule" ]; then
            DB_SERVER="$SECRET_DB_SERVER"
            DB_API_USER="$SECRET_DB_API_USER"
            DB_API_PW="$SECRET_DB_API_PW"
            DB_API_PORT="$SECRET_DB_API_PORT"
          fi

          # Determine simulation model branch
          BRANCH="main"

          if [ "$EVENT_NAME" = "workflow_dispatch" ] && [ -n "$INPUT_BRANCH" ]; then
            BRANCH="$INPUT_BRANCH"
          fi

          CURRENT_REF="$REF_NAME"
          if [ "$EVENT_NAME" = "pull_request" ]; then
            CURRENT_REF="$HEAD_REF"
          fi

          if [[ "$CURRENT_REF" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-rc[0-9]*$ ]]; then
            BRANCH="$SIMTOOLS_DB_SIMULATION_MODEL_VERSION"
          fi

          cat > .env <<EOF
          SIMTOOLS_DB_SERVER=$DB_SERVER
          SIMTOOLS_DB_API_USER=$DB_API_USER
          SIMTOOLS_DB_API_PW=$DB_API_PW
          SIMTOOLS_DB_API_PORT=$DB_API_PORT
          SIMTOOLS_DB_SIMULATION_MODEL=$SIMTOOLS_DB_SIMULATION_MODEL
          SIMTOOLS_DB_SIMULATION_MODEL_VERSION=$SIMTOOLS_DB_SIMULATION_MODEL_VERSION
          SIMTOOLS_DB_SIMULATION_MODEL_BRANCH=$BRANCH
          SIMTOOLS_SIMTEL_PATH=$SIMTOOLS_SIMTEL_PATH
          SIMTOOLS_CORSIKA_PATH=$SIMTOOLS_CORSIKA_PATH
          SIMTOOLS_CORSIKA_HE_INTERACTION=$SIMTOOLS_CORSIKA_HE_INTERACTION
          SIMTOOLS_CORSIKA_LE_INTERACTION=$SIMTOOLS_CORSIKA_LE_INTERACTION
          EOF

          echo "Generated .env:"
          cat .env

      - name: Install Python dependencies (prod container)
        if: contains(inputs.container_image, 'simtools-prod')
        run: |
          pip install --no-cache-dir pytest pytest-cov pytest-requirements pytest-xdist pytest-retry

      - name: Install Python dependencies (dev container)
        if: ${{ !contains(inputs.container_image, 'simtools-prod') }}
        run: |
          pip install --no-cache-dir -e '.[tests,dev,doc]'

      - name: Upload model data (local DB only)
        if: github.event_name != 'schedule'
        run: |
          source .env
          simtools-db-upload-model-repository \
            --db_simulation_model "$SIMTOOLS_DB_SIMULATION_MODEL" \
            --db_simulation_model_version "$SIMTOOLS_DB_SIMULATION_MODEL_VERSION" \
            --branch "$SIMTOOLS_DB_SIMULATION_MODEL_BRANCH"

      - name: Integration tests
        shell: bash -l {0}
        run: |
          source .env
          simtools-print-version
          pytest \
            --model_version=${{ matrix.model_version }} \
            --color=yes --durations=20 -n 4 \
            --dist loadscope --retries 2 --retry-delay 5 \
            --no-cov \
            tests/integration_tests/
