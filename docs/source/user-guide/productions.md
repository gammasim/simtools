# Simulation Productions

The production of large sets of simulated events is the core of the SimPipe framework and can be summarized in the following steps:

% TODO links
- `Configure and Produce Simulations`
- `Preparatory steps`

## Configure and Produce Simulations

The following steps are executed for each new simulation production in the order `Configure`_, `Produce`_, and `Verify and Report`_.

### Configure

```{warning}
Missing (TODO)

- description of job configuration.
- concept of Production Configuration repository.

```

Users configure new productions using templates from the SimPipe Production Configuration repository.

Configuration defines primary particles, observation parameters (zenith angle ranges, night-sky background (NSB) levels, array layouts), and production parameters including:

- SimPipe and Simulation Models versions
- Simulation production version
- Observational parameter grid definition (e.g., zenith angle binning)
- Required statistics or metric values for production sizing (e.g., effective collection area uncertainty)

Configuration triggers the following automated steps:

1. Derive CORSIKA configuration limits for the production grid using:
    a. lookup tables from `CORSIKA configuration lookup tables`_
    b. `simtools-production-generate-grid <https://gammasim.github.io/simtools/user-guide/applications/simtools-production-generate-grid.html>`_ to determine configuration parameters
2. Calculate required event statistics for each grid point (if not user-specified) using:
    a. metric parameters for statistical requirements (e.g., effective collection area uncertainty after gamma/hadron separation)
    b. DL2 event data (with or without gamma/hadron cuts applied) **TODO clear definition needed**
    c. `simtools-production-derive-statistics <https://gammasim.github.io/simtools/user-guide/applications/simtools-production-derive-statistics.html>`_ for event statistics calculation
3. Estimate required computing resources (optional) using:
    a. resource lookup tables
    b. (a missing simtools)
4. Configure production models
5. Write configuration files to SimPipe Production Configuration GitLab (energy ranges, versions, etc.) **TODO to be defined**
    a. includes configuration parameter versioning
    b. writing of CWL files here?

### Produce

```{warning}
Missing (TODO)

    - description of interface to WMS and how to submit jobs.
    - description of interface to BDMS and how output files are stored.

```

Uses `simtools-simulate-prod <https://gammasim.github.io/simtools/user-guide/applications/simtools-simulate-prod.html>`_
to execute for each production run on the compute nodes:

- queries the Simulation Models database to generate CORSIKA and sim_telarray configuration and model files
- generates run scripts for CORSIKA and sim_telarray (includes "multi-pipe" setup, meaning several sim_telarray for a single CORSIKA run)
- executes the air shower, telescopes, and array simulations
- collects final results including reduced event data and log files

The *Produce* step generates the following output files:

- log files from CORSIKA, sim_telarray, and simtools
- sim_telarray output files in eventio format (includes event data and histogram files)
- reduced event data files in HDF5 format generated by simtools using `simtools-generate-simtel-event-data <https://gammasim.github.io/simtools/user-guide/applications/simtools-generate-event-data.html>`_

### Verify and Report

- Verification of sim_telarray meta-parameters
- Verification for each sim_telarray output file (includes log files)
- Comparison with reference productions

## Preparatory Steps

### CORSIKA configuration lookup tables

Generate lookup tables for CORSIKA configuration limits as a function of zenith angle, night-sky background (NSB) level, and array layout.
Limits on energy, core scatter radius, and viewcone radius are derived from triggered simulation events generated from
simulation runs with generous settings.
Executed for major releases or significant configuration changes (e.g., increased telescope numbers):

- uses reduced event data files generated by `simtools-generate-simtel-event-data <https://gammasim.github.io/simtools/user-guide/applications/simtools-generate-event-data.html>`_ as input for each simulation run
- `simtools-merge-tables <https://gammasim.github.io/simtools/user-guide/applications/simtools-merge-tables.html>`_ merges sufficient reduced event data files into larger files (HDF5 format)
- `simtools-derive-corsika-config-limits <https://gammasim.github.io/simtools/user-guide/applications/simtools-derive-corsika-config-limits.html>`_ derives CORSIKA configuration limits for each zenith angle, NSB level, and array layout and generates lookup tables

Lookup tables are stored in the SimPipe Production Configuration gitlab repository.

```{warning}
Missing (TODO)

    - where are merged tables stored? Or temporarily generated and not stored?

```

## Old documentation

Simtools allows large-scale productions of simulated events required for the calculation of instrument response functions.
Simtools is designed to use the CTAO workload management system (WMS) and the HT Condor job submission system.

Pre-requisites for running productions:

- simtools is installed and configured on the job submission host.
- simulation software (CORSIKA and sim_telarray) are installed on the worker nodes or installed in a container (findable through `$SIMTOOLS_SIMTEL_PATH`) .
- simulation models are accessible through the simulation model database. This includes both the production tables and the model parameters.
- configuration parameters for the production (see e.g., [simulate_prod_gamma_20_deg_North.yml](../tests/integration_tests/config/simulate_prod_gamma_20_deg_North.yml))

Productions are configured and submitted using the `simtools-simulate-prod` application (or `simtools-simulate-prod-htcondor-generator` for HTCondor jobs).

## Local productions

Configure and submit a local production using the `simtools-simulate-prod` command.
The submit engine is configured with the `--submit_engine local` command line option, see
[simulate_prod_gamma_20_deg_North.yml](../tests/integration_tests/config/simulate_prod_gamma_20_deg_North.yml) for an example configuration.

Running a local production is a simple way to test the production system, but in general too slow to simulate a large number of events.

## Running simtools on HTCondor using Apptainers

Simtools can be run using HTCondor and Apptainers. Jobs are configured with the `simtools-simulate-prod-htcondor-generator` command.
Configuration is similar to the `simulate-prod` command, with the following additions:

- `APPTAINER_IMAGE` is the path to the Apptainer image to be used for the simulation.
- `PRIORITY` is the priority of the job in HTCondor.
- `RUN_NUMBER` and `NUMBER_OF_RUNS` are the first run number and the number of runs to be simulated.

The `simtools-simulate-prod-htcondor-generator` tool generates two files:

- a condor submission file to specify the apptainer, the number of jobs (equals the number of runs), the priority, and the output files.
- a condor submission script with the `simtools-simulate-prod` command to be run in the apptainer.

An example for the configuration `simtools-simulate-prod-htcondor-generator` can be found in [simulate_prod_htcondor_generator_gamma_20_deg_North.yml](tests/integration_tests/config/simulate_prod_htcondor_generator_gamma_20_deg_North.yml).

Container images are available from the GitHub and CTAO container registries and can be converted to Apptainer images using the `apptainer build` command.
Example:

```bash
apptainer build simtools.sif docker://ghcr.io/gammasim/simtools-prod-250304-corsika-78000-bernlohr-1.69-prod6-baseline-qgs3-avx2:20250507-154410
```

## Running Grid Productions

:::{danger}
Missing Documentation.
:::
